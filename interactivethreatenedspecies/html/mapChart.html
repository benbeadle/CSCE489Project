<html>
  <head>

    <!-- My CSS -->
    <link href="map.css" rel="stylesheet" type="text/css" />
    
    <!-- JQuery Links -->
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" />
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>

    <!-- Google Charts - GeoChart -->
    <script type='text/javascript' src='https://www.google.com/jsapi'></script>
   
    <!--Google App Engine -->
    <script src="https://apis.google.com/js/client.js?onload=load"></script>

    <script type='text/javascript'>

      var chart;
      var options;
      var data;
      var apiInitiated = false;

      function init() {
        apiInitiated = true;
        console.log("Loaded API");
      }

      function load() {
        var ROOT = 'https://interactivethreatenedspecies.appspot.com/_ah/api';
        gapi.client.load('speciesapi', 'v1', init, ROOT);
      }

      // Country Search bar stuff
      $(function() {
        var countryList = [];
        var countryId = [];

      // How to update the map once a country is selected
      function updateMap(country) {
        options = {
          region: country,
          colorAxis: {colors: ['blue', 'green','yellow', 'red']},
          displayMode: 'regions',
          resolution: 'country'
        };
        chart.draw(data, options);
      }

      // How to make the search bar function
      $( "#countryTags")
      .autocomplete({ // Calling Google App Engine here
        source: function(request, response) {
          if(apiInitiated) {
            // Request results based off what was entered
            var countriesObject = gapi.client. speciesapi.search.countries({'q':request.term});
            countriesObject.execute(function(countryResponse){
                countryList = []
                countryId = [];
                for(var i = 0; i < countryResponse.countries.length; i++) { 
                  //Fill in countries and ids for those countries
                  countryList.push(countryResponse.countries[i].name);
                  countryId.push(countryResponse.countries[i].code);
                }
                response(countryList)
            });
          }
          else {
            alert("API not initiated.");
          }              
        },
          select: function( event, ui ) {
            // When they select the country, find the right id and zoom to it
            for(var i = 0; i < countryList.length; i++) {
              if(countryList[i] == ui.item.value) { //TODO Check for countries we can't zoom to and not correct input
                updateMap( ui.item ? countryId[i] : this.value );
                return
              }
            }
          }
        });
      });

      // Animal Search Bar stuff here
      $(function() {
        var availableTags = [
          'Tiger',
          'Monkey',
          'Lizard',
          'Cat',
          'Dog',
          'Owl',
          'Bird'
        ];

        // TODO make this do something other than update the right panel
        function log( message ) {
          document.getElementById("rightconsole").innerHTML=message;
        }
      
        // How to make the search bar function
        $( "#animalTags" ).autocomplete({
          source: availableTags, // TODO API call to generate this
          select: function( event, ui ) {
            log( ui.item ?
              "Selected: " + ui.item.value :
              "Nothing selected, input was " + this.value );
          }
        });
      });  
   
      // Load google geochart stuff
      google.load('visualization', '1', {'packages': ['geochart']});
      google.setOnLoadCallback(drawRegionsMap);

      // Draw the original map
      function drawRegionsMap() {
        // Original data to use in map
        // TODO API call to generate this
        data = google.visualization.arrayToDataTable([
          ['Country', 'Extinct Animals'],
          ['Germany', 200],
          ['US', 300],
          ['Brazil', 400],
          ['Canada', 500],
          ['France', 600],
          ['RU', 700],
          ['China', 10]
        ]);

        // Original Options
        options = {
          colorAxis: {colors: ['blue', 'green','yellow', 'red']},
          displayMode: 'regions',
          resolution: 'country'
        };

        // Actually draw it
        chart = new google.visualization.GeoChart(document.getElementById('chart_div'));
        chart.draw(data, options);

        // TODO Add click stuff here
        google.visualization.events.addListener(chart, 'select', 
          function(eventData) {
            whereTheyClicked = chart.getSelection();  
            var country =  data.getValue(whereTheyClicked[0].row, 0);
            var text = 'You clicked: ' + country;
            document.getElementById("rightconsole").innerHTML=text;
        });
      };

    </script>
  </head>
  <body onload="load();">

    <div id='titlebar'>
      <h1>Team Planeteers Present...</h1>
    </div>
    
    <div id='searchbar'>
      <div class="ui-widget">
        <label for="countryTags">Country: </label>
        <input id="countryTags" />
        
        <label for="animalTags">Animal: </label>
        <input id="animalTags" />
      </div>
    </div>
    
    <div id="body">
      <div id="rightconsole">
      </div>

      <div id="leftconsole" >
        <div id="chart_div"></div>
      </div>
    </div>
  
  </body>
</html>